<div class="h-100" *ngIf="loading">
  <siscap-loading></siscap-loading>
</div>

<div class="row mx-1" *ngIf="!loading && formMode != 'criar'">
  <div class="d-flex justify-content-end p-0">
    <button
      class="btn btn-outline-primary d-flex justify-content-around"
      (click)="downloadDic()"
    >
      <i class="fa fa-file-arrow-down fs-5 mx-1 my-auto"></i>
      <span class="mx-1 fs-6">Gerar DIC</span>
    </button>
  </div>
</div>

<div class="project-form" *ngIf="!loading">
  <form [formGroup]="projetoForm">
    <div class="row mx-1">
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-12 col-md-3 mb-2 mb-md-0">
              <label for="sigla" class="form-label col-12">
                Sigla do Projeto
                <ng-container
                  *ngTemplateOutlet="
                    appAlert;
                    context: { controlName: 'sigla' }
                  "
                ></ng-container>
              </label>
              <input
                mask=""
                [inputTransformFn]="toUppercaseInputTransformFn"
                [outputTransformFn]="toUppercaseOutputTransformFn"
                type="text"
                class="form-control"
                id="sigla"
                formControlName="sigla"
                maxlength="12"
              />
            </div>

            <div class="col-12 col-md-9">
              <label for="titulo" class="form-label col-12">
                Título do Projeto
                <ng-container
                  *ngTemplateOutlet="
                    appAlert;
                    context: { controlName: 'titulo' }
                  "
                ></ng-container>
              </label>
              <input
                type="text"
                class="form-control"
                id="titulo"
                formControlName="titulo"
                maxLength="150"
              />
            </div>
          </div>

          <div class="row">
            <div class="col-12 col-md-6" id="orgao">
              <label for="idOrganizacao" class="form-label col-12">
                Orgão de Origem
                <ng-container
                  *ngTemplateOutlet="
                    appAlert;
                    context: { controlName: 'idOrganizacao' }
                  "
                ></ng-container>
              </label>
              <ng-select
                id="idOrganizacao"
                placeholder="-- Selecione um orgão da lista abaixo --"
                formControlName="idOrganizacao"
              >
                <ng-option
                  *ngFor="let organizacao of organizacoesList"
                  [value]="organizacao.id"
                  >{{ organizacao.nome }}</ng-option
                >
              </ng-select>
            </div>

            <div class="col-12 col-md-6" id="responsavel-proponente">
              <label for="responsavelProponente" class="form-label col-12">
                Responsável Proponente
                <ng-container
                  *ngTemplateOutlet="
                    appAlert;
                    context: { controlName: 'idResponsavelProponente' }
                  "
                ></ng-container>
              </label>
              <ng-select
                id="responsavelProponente"
                placeholder="-- Selecione o responsável proponente --"
                formControlName="idResponsavelProponente"
              >
                <ng-option
                  *ngFor="let pessoa of pessoasList"
                  [value]="pessoa.id"
                  >{{ pessoa.nome }}</ng-option
                >
              </ng-select>
            </div>
          </div>

          <div class="row" *ngIf="getControl('idResponsavelProponente')?.value">
            <div class="col-12">
              <label for="membroEquipeElaboracao" class="col-12 form-label"
                >Equipe de Elaboração
                <ng-container
                  *ngTemplateOutlet="
                    appAlert;
                    context: { controlName: 'equipeElaboracao' }
                  "
                ></ng-container>
              </label>

              <ng-select
                id="idMembroEquipeElaboracao"
                placeholder="-- Selecione uma pessoa para incluir na equipe de elaboração --"
                [(ngModel)]="idMembroEquipeElaboracao"
                [ngModelOptions]="{ standalone: true }"
                [disabled]="!isEdit"
                (change)="idMembroNgSelectChangeEvent($event)"
              >
                <ng-option
                  *ngFor="
                    let pessoa of equipeService.filtrarPessoasList(
                      filtrarResponsavelProponente(pessoasList)
                    )
                  "
                  [value]="pessoa.id"
                >
                  {{ pessoa.nome }}
                </ng-option>
              </ng-select>
            </div>
            <div class="col-12 mt-2">
              <siscap-equipe-form
                [pessoasList]="pessoasList"
                [papeisList]="papeisList"
                [formMode]="formMode"
                [isEdit]="isEdit"
              ></siscap-equipe-form>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <label for="valorEstimado" class="form-label col-12">
                Valor Estimado
                <ng-container
                  *ngTemplateOutlet="
                    appAlert;
                    context: { controlName: 'valorEstimado' }
                  "
                ></ng-container>
              </label>
              <input
                type="text"
                mask="separator.2"
                prefix="R$"
                thousandSeparator="."
                decimalMarker=","
                [inputTransformFn]="rtlCurrencyInputTransformFn"
                [outputTransformFn]="rtlCurrencyOutputTransformFn"
                class="form-control"
                id="valorEstimado"
                formControlName="valorEstimado"
                min="1"
              />
            </div>
          </div>

          <!-- VER MELHOR SE VALE A PENA USAR *ngIf, [ngClass] OU NADA -->
          <!-- 
            1. *ngIf: BASEADO SE valorEstimado É NULO OU NÃO
                PROS: 
                |-> IMPEDE SEQUER O INICIO DE MANIPULAÇÃO DO RATEIO, EVITA ERROS

                CONS:
                |-> POSSIVEIS PROBLEMAS DURANTE INICIALIZACAO (PRINCIPALMENTE EM EDIÇÃO)
                |-> ONERA O SISTEMA (SEMPRE QUE valorEstimado FOR NULO, CARREGA TUDO DE NOVO)
          

            2. [ngClass]: APLICA CLASSE BOOTSTRAP 'invisible' QUANDO valorEstimado FOR NULO
                PROS:
                |-> NÃO ONERA O SISTEMA (RATEIO CRIADO UMA VEZ, DADOS MANTÉM)

                CONS:
                |-> OCUPA ESPAÇO NO DOM ("EMPURRA" TODO O RESTO DO CONTEUDO PRA BAIXO)

            3. NADA: 
                PROS:
                |-> NÃO ONERA O SISTEMA (RATEIO CRIADO UMA VEZ, DADOS MANTÉM)

                CONS:
                |-> MEIO QUE ONERA O SISTEMA SIM:
                  |-> PRECISA CRIAR UM MONTE DE fromEvent() CAPTURANDO BOTÕES, INPUTS
                      PRA APLICAR event.preventDefault() CASO valorEstimado SEJA NULO
          -->

          <!-- [ngClass]="{ invisible: !getControl('valorEstimado').value }" -->
          <!-- <div class="row" *ngIf="getControl('valorEstimado')?.value"> -->
          <div class="row">
            <div class="col-12 my-1">
              <label for="rateio" class="form-label col-12">
                Rateio
                <ng-container
                  *ngTemplateOutlet="
                    appAlert;
                    context: { controlName: 'rateio' }
                  "
                ></ng-container>
              </label>
              <new-rateio-form
                [microrregioesList]="microrregioesList"
                [cidadesComMicrorregiaoList]="cidadesComMicrorregiaoList"
                [formMode]="formMode"
                [isEdit]="isEdit"
              ></new-rateio-form>
              <!-- <siscap-rateio-form
                [context]="'PROJETO'"
                [formMode]="formMode"
                [isEdit]="isEdit"
                [targetRateioArray]="oldRateioService.rateio"
                [listArrays]="{
                  microrregioesCidadesList: microrregioesCidadesList
                }"
              ></siscap-rateio-form> -->
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <label for="objetivo" class="form-label col-12">
                Objetivo
                <ng-container
                  *ngTemplateOutlet="
                    appAlert;
                    context: { controlName: 'objetivo' }
                  "
                ></ng-container>
              </label>
              <textarea
                class="form-control"
                id="objetivo"
                formControlName="objetivo"
                maxLength="2000"
              ></textarea>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <label for="objetivoEspecifico" class="form-label col-12">
                Objetivo Específico
                <ng-container
                  *ngTemplateOutlet="
                    appAlert;
                    context: { controlName: 'objetivoEspecifico' }
                  "
                ></ng-container>
              </label>
              <textarea
                class="form-control"
                id="objetivoEspecifico"
                formControlName="objetivoEspecifico"
                maxLength="2000"
              ></textarea>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <label for="situacaoProblema" class="form-label col-12">
                Situação Problema
                <ng-container
                  *ngTemplateOutlet="
                    appAlert;
                    context: { controlName: 'situacaoProblema' }
                  "
                ></ng-container>
              </label>

              <textarea
                class="form-control"
                id="situacaoProblema"
                formControlName="situacaoProblema"
                maxLength="2000"
              ></textarea>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <label for="solucoesPropostas" class="form-label col-12">
                Soluções Propostas/Resultados Esperados
                <ng-container
                  *ngTemplateOutlet="
                    appAlert;
                    context: { controlName: 'solucoesPropostas' }
                  "
                ></ng-container>
              </label>
              <textarea
                class="form-control"
                id="solucoesPropostas"
                formControlName="solucoesPropostas"
                maxLength="2000"
              ></textarea>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <label for="impactos">
                Impactos do Projeto no Âmbito Ambiental, Social e de Governança
                (ESG)
                <ng-container
                  *ngTemplateOutlet="
                    appAlert;
                    context: { controlName: 'impactos' }
                  "
                ></ng-container>
              </label>
              <textarea
                class="form-control"
                id="impactos"
                formControlName="impactos"
                maxLength="2000"
              ></textarea>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <label for="arranjosInstitucionais" class="form-label col-12">
                Arranjo Institucional
                <ng-container
                  *ngTemplateOutlet="
                    appAlert;
                    context: { controlName: 'arranjosInstitucionais' }
                  "
                ></ng-container>
              </label>
              <textarea
                class="form-control"
                id="arranjosInstitucionais"
                formControlName="arranjosInstitucionais"
                maxLength="2000"
              ></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<ng-template #appAlert let-controlName="controlName">
  <siscap-alert [control]="getControl(controlName)"></siscap-alert>
</ng-template>
